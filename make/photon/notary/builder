#!/bin/bash

set +e

if [ -z $2 ]; then
  error "Please set the notary and migrate version"
  exit 1
fi

echo "Building notary and golang-migrate from source, notary version: $1, golang-migrate version: $2"
set -e

# the temp folder to store binary file...
mkdir -p binary
# don't remove all like migrate-patch-* which generated by `make compile_notary_migrate_patch`
rm -rf binary/notary-* || true;
rm -rf binary/migrate-linux-* || true;
rm -rf binary/migrations || true;

cd `dirname $0`

NOTARY_VERSION=$1
MIGRATE_VERSION=$2


echo "build binary notary binaries..."
docker build --build-arg TARGETARCHS="${TARGETARCHS}" --build-arg NOTARY_VERSION=${NOTARY_VERSION} --build-arg MIGRATE_VERSION=${MIGRATE_VERSION} -f ./binary.Dockerfile -t notary-binary .

echo 'copy the binary files to local...'
ID=$(docker create notary-binary)

for targetarch in ${TARGETARCHS}; do
  docker cp $ID:/go/bin/notary-server-linux-${targetarch} binary/notary-server-linux-${targetarch}
  docker cp $ID:/go/bin/notary-signer-linux-${targetarch} binary/notary-signer-linux-${targetarch}
  docker cp $ID:/go/bin/migrate-linux-${targetarch} binary/migrate-linux-${targetarch}
done

docker cp $ID:/migrations binary/migrations
sed -i 's/waiting for $DB_URL/waiting for database/g' binary/migrations/migrate.sh;

docker rm -f $ID
docker rmi -f notary-binary